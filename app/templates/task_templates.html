{% extends "base.html" %}
{% block content %}
{% set category_names = categories | map(attribute='name') | list %}
<h1>{{ strings['templates.heading'] }}</h1>
<div class="grid">
    <div class="card">
        <h3>{{ strings['templates.new'] }}</h3>
        <form method="post" enctype="multipart/form-data">
            <label>Title / タイトル<input type="text" name="title" required></label>
            <label>Default category / カテゴリ
                <select name="default_category">
                    <option value="">-</option>
                    {% for cat in categories %}
                    <option value="{{ cat.name }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Default points / ポイント<input type="number" name="default_points"></label>
            <label>{{ strings['templates.relative'] }}<input type="number" name="relative_due_days" placeholder="3"></label>
            <label>{{ strings['templates.memo'] }}<textarea name="memo"></textarea></label>
            <label>{{ strings['templates.instructions'] }} (AsciiDoc OK)<textarea name="instructions" placeholder="= Heading\n* step\nimage::https://..."></textarea></label>
            <label>{{ strings['templates.upload'] }}<input type="file" name="instruction_image_file" accept="image/*"></label>
            <label>Image URL / 画像URL<input type="url" name="instruction_image_url" placeholder="https://..."></label>
            <p class="muted">{{ strings['templates.embedGuide'] }} {{ strings['tasks.instructionsHint'] }}</p>
            <button type="submit">{{ strings['templates.save'] }}</button>
        </form>
    </div>
    <div class="card">
        <div class="filters">
            <form method="get">
                <label>カテゴリで絞り込み
                    <select name="category" onchange="this.form.submit()">
                        <option value="">全て</option>
                        {% for cat in categories %}
                        <option value="{{ cat.name }}" {% if selected_category==cat.name %}selected{% endif %}>{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
        </div>
        <h3>{{ strings['templates.existing'] }}</h3>
        {% if templates %}
            {% for t in templates %}
            <div class="template-edit">
                <div class="template-preview">
                    <h4>{{ t.title }}</h4>
                    <p class="muted">{{ t.default_category or '-' }} / ⭐ {{ t.default_points or '-' }} / +{{ t.relative_due_days if t.relative_due_days is not none else '-' }} days</p>
                    {% if t.instructions %}
                        <div class="instruction-body">{{ render_instructions(t.instructions) }}</div>
                    {% endif %}
                    {% if t.instruction_image_url %}
                        <div class="instruction-image-wrap"><img src="{{ t.instruction_image_url }}" alt="template image"></div>
                    {% endif %}
                </div>
                <form method="post" action="/templates/tasks/{{ t.id }}/edit" class="template-form" enctype="multipart/form-data">
                    <label>Title / タイトル<input type="text" name="title" value="{{ t.title }}" required></label>
                    <label>Default category / カテゴリ
                        <select name="default_category">
                            <option value="">-</option>
                            {% for cat in categories %}
                            <option value="{{ cat.name }}" {% if t.default_category==cat.name %}selected{% endif %}>{{ cat.name }}</option>
                            {% endfor %}
                            {% if t.default_category and t.default_category not in category_names %}
                            <option value="{{ t.default_category }}" selected>{{ t.default_category }}</option>
                            {% endif %}
                        </select>
                    </label>
                    <label>Default points / ポイント<input type="number" name="default_points" value="{{ t.default_points or '' }}"></label>
                    <label>{{ strings['templates.relative'] }}<input type="number" name="relative_due_days" value="{{ t.relative_due_days if t.relative_due_days is not none else '' }}"></label>
                    <label>{{ strings['templates.memo'] }}<textarea name="memo">{{ t.memo or '' }}</textarea></label>
                    <label>{{ strings['templates.instructions'] }}<textarea name="instructions">{{ t.instructions or '' }}</textarea></label>
                    <label>{{ strings['templates.upload'] }}<input type="file" name="instruction_image_file" accept="image/*"></label>
                    <label>Image URL / 画像URL<input type="url" name="instruction_image_url" value="{{ t.instruction_image_url or '' }}"></label>
                    <div class="actions">
                        <button type="submit">{{ strings['templates.update'] }}</button>
                    </div>
                </form>
                <form method="post" action="/templates/tasks/{{ t.id }}/delete" class="inline">
                    <button type="submit" class="ghost">{{ strings['templates.delete'] }}</button>
                </form>
            </div>
            {% endfor %}
        {% else %}
        <p class="muted">{{ strings['tasks.noTemplates'] }}</p>
        {% endif %}
    </div>
</div>
{% endblock %}
