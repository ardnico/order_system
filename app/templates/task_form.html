{% extends "base.html" %}
{% block content %}
{% set is_edit = task is defined %}
<h1>{{ strings['tasks.edit'] if is_edit else strings['tasks.new'] }}</h1>
<form method="post" class="card" action="{{ '/tasks/' ~ task.id ~ '/edit' if is_edit else '/tasks/new' }}">
    {% if template %}
    <input type="hidden" name="task_template_id" value="{{ template.id }}">
    {% endif %}
    <label>タイトル / Title<input type="text" name="title" value="{{ task.title if is_edit else (template.title if template else '') }}" required></label>
    <label>説明 / Description<textarea name="description">{{ task.description if is_edit else (template.memo if template else '') }}</textarea></label>
    <label>カテゴリ / Category
        {% set selected_category = task.category if is_edit else (template.default_category if template else '') %}
        {% set category_names = categories | map(attribute='name') | list if categories is defined else [] %}
        <select name="category">
            {% for cat in categories %}
            <option value="{{ cat.name }}" {% if cat.name==selected_category %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
            {% if selected_category and selected_category not in category_names %}
            <option value="{{ selected_category }}" selected>{{ selected_category }}</option>
            {% endif %}
        </select>
        <p class="muted"><a href="/settings">カテゴリを管理する</a></p>
    </label>
    <label>期限 / Due date<input type="date" name="due_date" value="{{ task.due_date if is_edit else default_due_date }}" required></label>
    <label>時間 / Due time<input type="time" name="due_time" value="{{ task.due_time.strftime('%H:%M') if is_edit and task.due_time else '' }}"></label>
    <label>ポイント / Proposed points<input type="number" name="proposed_points" value="{{ task.proposed_points if is_edit else (template.default_points if template and template.default_points is not none else '') }}" required></label>
    <label>優先度 / Priority (1-5)<input type="number" min="1" max="5" name="priority" value="{{ task.priority if is_edit else 3 }}" required></label>
    <label>{{ strings["tasks.assignee"] }}
        {% set selected_assignee = task.assignee_user_id if is_edit else user.id %}
        <select name="assignee_user_id">
            {% for member in assignees %}
                <option value="{{ member.id }}" {% if selected_assignee == member.id %}selected{% endif %}>{{ member.display_name }}</option>
            {% endfor %}
            <option value="" {% if not selected_assignee %}selected{% endif %}>-</option>
        </select>
    </label>
    <label>メモ / Notes<textarea name="notes">{{ task.notes if is_edit else '' }}</textarea></label>
    <div class="actions">
        <button type="submit">{{ strings['tasks.save'] if is_edit else strings['tasks.new'] }}</button>
        {% if is_edit %}<a class="ghost" href="/tasks/{{ task.id }}">{{ strings['tasks.cancel'] }}</a>{% endif %}
    </div>
</form>
{% endblock %}
