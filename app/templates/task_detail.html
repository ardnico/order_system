{% extends "base.html" %}
{% block content %}
<div class="page-header">
    <div>
        <p class="eyebrow">{{ strings['tasks.heading'] }}</p>
        <h1>#{{ task.order_number }} {{ task.title }}</h1>
    </div>
    <div class="status-pill status-{{ task.status }}">{{ translate_status(task.status, language) }}</div>
</div>

<div class="card task-detail">
    <div class="detail-grid">
        <div>
            <p class="muted">{{ strings['tasks.assignee'] }}</p>
            <p>{% if assignee %}{{ assignee.display_name }}{% else %}-{% endif %}</p>
        </div>
        <div>
            <p class="muted">{{ strings['tasks.due'] }}</p>
            <p>{{ task.due_date }} {% if task.due_time %}{{ task.due_time }}{% endif %}</p>
        </div>
        <div>
            <p class="muted">{{ strings['tasks.category'] }}</p>
            <p>{{ task.category }}</p>
        </div>
        <div>
            <p class="muted">{{ strings['tasks.priority'] }}</p>
            <p>{{ task.priority }}</p>
        </div>
        <div>
            <p class="muted">{{ strings['tasks.points'] }}</p>
            <p>⭐ {{ task.proposed_points }} / {{ task.actual_points or '-' }}</p>
        </div>
        <div>
            <p class="muted">{{ strings['tasks.creator'] }}</p>
            <p>{{ creator.display_name }}</p>
        </div>
    </div>
    <div class="description">
        <h3>{{ strings['tasks.description'] }} / 説明</h3>
        <p class="pre">{{ task.description or '-' }}</p>
    </div>
    {% if template and template.instructions %}
    <div class="instructions">
        <h3>{{ strings['templates.instructions'] }}</h3>
        <div class="instruction-body">{{ render_instructions(template.instructions) }}</div>
        {% if template.instruction_image_url %}
        <div class="instruction-image-wrap"><img src="{{ template.instruction_image_url }}" alt="instruction image"></div>
        {% endif %}
    </div>
    {% endif %}
    <div class="notes">
        <h3>{{ strings['tasks.notes'] }} / メモ</h3>
        <p class="pre">{{ task.notes or '-' }}</p>
    </div>
    <div class="order-link"><a class="ghost" href="/tasks/{{ task.id }}/order">{{ strings['tasks.orderSheet'] }}</a> | <a class="ghost" href="/tasks/{{ task.id }}/edit">{{ strings['tasks.edit'] }}</a></div>
</div>

    <div class="actions">
        {% if task.status == 'open' %}
        <form method="post" action="/tasks/{{ task.id }}/action">
            <input type="hidden" name="action" value="claim">
            <label>{{ strings['tasks.points'] }}<input type="number" name="actual_points" value="{{ task.actual_points or task.proposed_points }}"></label>
            <button type="submit">{{ strings['tasks.claim'] }}</button>
        </form>
        {% endif %}
        {% if task.status in ['open','assigned'] %}
        <form method="post" action="/tasks/{{ task.id }}/action">
            <input type="hidden" name="action" value="start">
            <label>{{ strings['tasks.points'] }}<input type="number" name="actual_points" value="{{ task.actual_points or task.proposed_points }}"></label>
            <button type="submit">{{ strings['tasks.start'] }}</button>
        </form>
        {% endif %}
    {% if task.status in ['assigned','in_progress'] %}
    <form method="post" action="/tasks/{{ task.id }}/action">
        <input type="hidden" name="action" value="complete">
        <label>{{ strings['tasks.points'] }} (optional)<input type="number" name="actual_points"></label>
        <button type="submit">{{ strings['tasks.submit'] }}</button>
    </form>
    {% endif %}
    {% if task.status == 'completed' %}
    <form method="post" action="/tasks/{{ task.id }}/action">
        <input type="hidden" name="action" value="approve">
        <label>{{ strings['tasks.points'] }}<input type="number" name="actual_points" value="{{ task.actual_points or task.proposed_points }}"></label>
        <button type="submit">{{ strings['tasks.approve'] }}</button>
    </form>
    {% endif %}
    {% if task.status not in ['approved','cancelled'] %}
    <form method="post" action="/tasks/{{ task.id }}/action">
        <input type="hidden" name="action" value="cancel">
        <button type="submit">{{ strings['tasks.cancel'] }}</button>
    </form>
    {% endif %}
</div>
{% if related_tx %}
<p>{{ strings['tasks.pointsAwarded'] }}: {{ related_tx.amount }} ({{ related_tx.description }})</p>
{% endif %}
{% endblock %}
