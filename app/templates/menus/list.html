{% extends "base.html" %}
{% block content %}
<datalist id="ingredient-options">
    {% for ing in ingredient_options %}
    <option value="{{ ing.name }}"></option>
    {% endfor %}
</datalist>
<h1>{{ strings["menus.heading"] }}</h1>
<div class="grid">
    <div class="card">
        <h2>{{ strings["menus.new"] }}</h2>
        <form method="post" action="/menus" enctype="multipart/form-data">
            <label>{{ strings["menus.name"] }}
                <input name="name" required list="ingredient-options" autocomplete="off">
            </label>
            <label>{{ strings["menus.description"] }}
                <textarea name="description"></textarea>
            </label>
            <label>料理タイプ
                <select name="dish_type_id">
                    <option value="">(選択)</option>
                    {% for dt in dish_types %}
                    <option value="{{ dt.id }}">{{ dt.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>{{ strings["menus.image"] }}
                <input type="file" name="image_file" accept="image/*">
            </label>
            <h3>{{ strings["menus.ingredients"] }}</h3>
            <table>
                <tr>
                    <th>{{ strings["menus.ingredients"] }}</th>
                    <th>{{ strings["menus.quantity"] }}</th>
                    <th>{{ strings["menus.unit"] }}</th>
                </tr>
                <tbody id="ingredient-rows">
                    {% for i in range(5) %}
                    <tr>
                        <td><input name="ingredient_names" list="ingredient-options" autocomplete="off" class="ing-name"></td>
                        <td><input name="ingredient_quantities" type="number" step="0.1"></td>
                        <td>
                            <select name="ingredient_units">
                                <option value=""></option>
                                {% for unit in unit_options %}
                                <option value="{{ unit.name }}">{{ unit.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" class="ghost" id="add-row">{{ strings["menus.addRow"] }}</button>
            <button type="submit">{{ strings["menus.save"] }}</button>
        </form>
    </div>
    <div class="card">
        <h2>{{ strings["templates.existing"] }}</h2>
        {% for menu in menus %}
        <div class="card">
            <div class="task-card-header">
                <div class="task-title">{{ menu.name }}</div>
                <div class="actions">
                    <a class="ghost" href="/menus/{{ menu.id }}/edit">{{ strings["menus.edit"] }}</a>
                    <form method="post" action="/menus/{{ menu.id }}/delete">
                        <button type="submit">{{ strings["menus.delete"] }}</button>
                    </form>
                </div>
            </div>
            {% if menu.image_url %}
            <div class="menu-thumb"><img src="{{ menu.image_url }}" alt="{{ menu.name }}" loading="lazy"></div>
            {% endif %}
            {% if menu.dish_type_id %}
            <p class="muted">タイプ: {{ dish_types|selectattr('id','equalto',menu.dish_type_id)|map(attribute='name')|list|first }}</p>
            {% endif %}
            {% if menu.description %}<p class="muted">{{ menu.description }}</p>{% endif %}
            <ul>
                {% for ing in ingredients_map.get(menu.id, []) %}
                <li>{{ ing.name }} — {{ ing.quantity }} {{ ing.unit or '' }}</li>
                {% endfor %}
                {% if not ingredients_map.get(menu.id) %}
                <li class="muted">{{ strings["templates.noTemplates"] }}</li>
                {% endif %}
            </ul>
        </div>
        {% else %}
        <p class="muted">{{ strings["menus.none"] if strings.get("menus.none") else "No menus" }}</p>
        {% endfor %}
    </div>
</div>
<script type="application/json" id="ingredient-data">{{ ingredient_data|tojson }}</script>
<script>
    const ingredientData = JSON.parse(document.getElementById('ingredient-data').textContent);
    const unitLookup = {};
    ingredientData.forEach((ing) => {
        if (ing.unit) {
            unitLookup[ing.name.toLowerCase()] = ing.unit;
        }
    });
    const tbody = document.getElementById('ingredient-rows');
    const addRowBtn = document.getElementById('add-row');
    function attachUnitBehavior(row) {
        const nameInput = row.querySelector('.ing-name');
        const unitSelect = row.querySelector('select[name="ingredient_units"]');
        nameInput?.addEventListener('change', () => {
            const unit = unitLookup[nameInput.value.toLowerCase()];
            if (unit && !unitSelect.value) {
                unitSelect.value = unit;
            }
        });
    }
    Array.from(tbody.querySelectorAll('tr')).forEach(attachUnitBehavior);
    addRowBtn.addEventListener('click', () => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input name="ingredient_names" list="ingredient-options" autocomplete="off" class="ing-name"></td>
            <td><input name="ingredient_quantities" type="number" step="0.1"></td>
            <td>
                <select name="ingredient_units">
                    <option value=""></option>
                    {% for unit in unit_options %}
                    <option value="{{ unit.name }}">{{ unit.name }}</option>
                    {% endfor %}
                </select>
            </td>`;
        tbody.appendChild(row);
        attachUnitBehavior(row);
    });
</script>
{% endblock %}
