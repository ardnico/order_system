{% extends "base.html" %}
{% block content %}
<h1>{{ strings['settings.heading'] }}</h1>
<div class="grid">
    <div class="card">
        <h3>{{ strings['settings.language'] }}</h3>
        <form method="post" action="/settings/language">
            <label>
                <span>{{ strings['settings.householdName'] }}</span>
                <input type="text" name="household_name" value="{{ household.name if household else '' }}" required>
            </label>
            <label>
                <span>{{ strings['settings.joinCode'] }}</span>
                <div class="inline-form">
                    <input type="text" name="join_code" value="{{ household.join_code if household else '' }}" placeholder="{{ strings['settings.joinCode.placeholder'] }}">
                    <button type="submit" name="regenerate_join_code" value="1" class="ghost">{{ strings['settings.joinCode.regenerate'] }}</button>
                </div>
                <p class="muted">{{ strings['settings.joinCode.description'] }}</p>
            </label>
            <label>
                <span>UI Language / 言語</span>
                <select name="language">
                    <option value="en" {% if household and household.language=='en' %}selected{% endif %}>{{ strings['settings.language.en'] }}</option>
                    <option value="ja" {% if household and household.language=='ja' %}selected{% endif %}>{{ strings['settings.language.ja'] }}</option>
                </select>
            </label>
            <label>
                <span>{{ strings['settings.theme'] }}</span>
                <select name="theme">
                    {% for theme_key in theme_choices %}
                    <option value="{{ theme_key }}" {% if household and household.theme==theme_key %}selected{% endif %}>{{ strings['settings.theme.' ~ theme_key] }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                <span>{{ strings['settings.font'] }}</span>
                <select name="font">
                    {% for font_key in font_choices %}
                    <option value="{{ font_key }}" {% if household and household.font==font_key %}selected{% endif %}>{{ strings['settings.font.' ~ font_key] }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">{{ strings['settings.update'] }}</button>
        </form>
    </div>
    <div class="card">
        <h3>{{ strings['settings.recurring'] }}</h3>
        <form method="post" action="/settings/recurring" class="stack">
            <label>Template / テンプレート
                <select name="task_template_id" required>
                    {% for t in templates %}
                    <option value="{{ t.id }}">{{ t.title }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Frequency / 生成間隔
                <select name="frequency">
                    <option value="daily">{{ strings['settings.frequency.daily'] }}</option>
                    <option value="weekly" selected>{{ strings['settings.frequency.weekly'] }}</option>
                    <option value="monthly">{{ strings['settings.frequency.monthly'] }}</option>
                </select>
            </label>
            <label>{{ strings['settings.recurring.next'] }}<input type="date" name="next_run_date" value="{{ (today or '').isoformat() if today else '' }}"></label>
            <label>{{ strings['tasks.assignee'] }}
                <select name="assignee_user_id">
                    <option value="">-</option>
                    {% for member in assignees %}
                    <option value="{{ member.id }}">{{ member.display_name }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">{{ strings['settings.recurring.add'] }}</button>
        </form>
        <div class="rule-list">
            {% for r in recurring_rules %}
            <div class="rule">
                <div>
                    <strong>{{ strings['settings.frequency.' ~ r.frequency] }} • {{ r.next_run_date }}</strong>
                    <p class="muted">Template #{{ r.task_template_id }} → {% if r.assignee_user_id %}{{ assignee_map[r.assignee_user_id].display_name if assignee_map.get(r.assignee_user_id) else r.assignee_user_id }}{% else %}未アサイン{% endif %}</p>
                </div>
                <form method="post" action="/settings/recurring/{{ r.id }}/toggle">
                    <label class="switch">
                        <input type="checkbox" name="active" value="on" {% if r.active %}checked{% endif %} onchange="this.form.submit()">
                        <span>{{ strings['tasks.active'] }}</span>
                    </label>
                </form>
            </div>
            {% else %}
            <p class="muted">{{ strings['settings.recurring.none'] }}</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h3>食材単位の管理</h3>
        <form method="post" action="/settings/unit-options" class="inline-form">
            <label>単位
                <input name="name" placeholder="例: 個" required>
            </label>
            <button type="submit">追加</button>
        </form>
        <ul class="muted">
            {% for unit in unit_options %}
            <li>{{ unit.name }}</li>
            {% else %}
            <li>まだ単位がありません</li>
            {% endfor %}
        </ul>
    </div>
    <div class="card">
        <h3>{{ strings['settings.categories'] }}</h3>
        <form method="post" action="/settings/categories" class="inline-form">
            <label>{{ strings['settings.categories'] }}
                <input name="name" placeholder="掃除" required>
            </label>
            <button type="submit">{{ strings['settings.categories.add'] }}</button>
        </form>
        <ul>
            {% for c in categories %}
            <li>
                <form method="post" action="/settings/categories/{{ c.id }}/edit" class="inline-form">
                    <input type="text" name="name" value="{{ c.name }}" required>
                    <button type="submit">更新</button>
                </form>
                <form method="post" action="/settings/categories/{{ c.id }}/delete" class="inline"><button type="submit" class="ghost">削除</button></form>
            </li>
            {% else %}
            <li class="muted">まだカテゴリがありません</li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h3>{{ strings['settings.dishTypes'] }}</h3>
        <form method="post" action="/settings/dish-types" class="inline-form">
            <label>名前<input name="name" required></label>
            <label>説明<input name="description"></label>
            <button type="submit">追加</button>
        </form>
        <ul>
            {% for dt in dish_types %}
            <li>
                <form method="post" action="/settings/dish-types/{{ dt.id }}/edit" class="inline-form">
                    <input type="text" name="name" value="{{ dt.name }}" required>
                    <input type="text" name="description" value="{{ dt.description or '' }}" placeholder="説明">
                    <button type="submit">更新</button>
                </form>
                <form method="post" action="/settings/dish-types/{{ dt.id }}/delete" class="inline"><button type="submit" class="ghost">削除</button></form>
            </li>
            {% else %}
            <li class="muted">タイプがありません</li>
            {% endfor %}
        </ul>
    </div>
    <div class="card">
        <h3>{{ strings['settings.mealSets'] }}</h3>
        <p class="muted">セットを選ぶと種別ごとのメニューを要求します。</p>
        <form method="post" action="/settings/meal-sets" class="stack">
            <label>セット名<input type="text" name="name" required></label>
            <label>説明<textarea name="description"></textarea></label>
            <div class="grid">
                {% for dt in dish_types %}
                <label>{{ dt.name }}<input type="number" name="requirement_{{ dt.id }}" min="0" value="0"></label>
                {% endfor %}
            </div>
            <button type="submit">追加</button>
        </form>
        <h4>既存セット</h4>
        <div class="stack">
            {% for s in meal_sets %}
            <div class="card">
                <strong>{{ s.name }}</strong>
                <p class="muted">{{ s.description or '-' }}</p>
                <form method="post" action="/settings/meal-sets/{{ s.id }}/edit" class="stack">
                    <label>セット名<input type="text" name="name" value="{{ s.name }}" required></label>
                    <label>説明<textarea name="description">{{ s.description or '' }}</textarea></label>
                    <div class="grid">
                        {% for dt in dish_types %}
                        {% set reqs = meal_set_requirements.get(s.id, []) %}
                        {% set match = reqs | selectattr('dish_type_id','equalto', dt.id) | list %}
                        {% set count = match[0].required_count if match else 0 %}
                        <label>{{ dt.name }}<input type="number" name="requirement_{{ dt.id }}" min="0" value="{{ count }}"></label>
                        {% endfor %}
                    </div>
                    <button type="submit">更新</button>
                </form>
                <form method="post" action="/settings/meal-sets/{{ s.id }}/delete" class="inline"><button type="submit" class="ghost">削除</button></form>
            </div>
            {% else %}
            <p class="muted">セットが未登録です</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h3>{{ strings['data.heading'] }}</h3>
        <p class="muted">{{ strings['data.description'] }}</p>
        <div class="actions">
            <a class="button" href="/data/export">{{ strings['data.export'] }}</a>
            <a class="ghost" href="/ingredients">{{ strings['ingredients.heading'] }}</a>
        </div>
        <form method="post" action="/data/import" enctype="multipart/form-data" class="stack">
            <label class="file-field">{{ strings['data.file'] }}
                <input type="file" name="file" accept="application/json" required>
            </label>
            <button type="submit">{{ strings['data.import'] }}</button>
        </form>
    </div>
</div>
{% endblock %}
