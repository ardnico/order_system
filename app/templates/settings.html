{% extends "base.html" %}
{% block content %}
<h1>{{ strings['settings.heading'] }}</h1>
<div class="grid">
    <div class="card">
        <h3>{{ strings['settings.language'] }}</h3>
        <form method="post" action="/settings/language">
            <label>
                <span>UI Language / 言語</span>
                <select name="language">
                    <option value="en" {% if household and household.language=='en' %}selected{% endif %}>{{ strings['settings.language.en'] }}</option>
                    <option value="ja" {% if household and household.language=='ja' %}selected{% endif %}>{{ strings['settings.language.ja'] }}</option>
                </select>
            </label>
            <label>
                <span>{{ strings['settings.theme'] }}</span>
                <select name="theme">
                    {% for theme_key in theme_choices %}
                    <option value="{{ theme_key }}" {% if household and household.theme==theme_key %}selected{% endif %}>{{ strings['settings.theme.' ~ theme_key] }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">{{ strings['settings.update'] }}</button>
        </form>
    </div>
    <div class="card">
        <h3>{{ strings['settings.recurring'] }}</h3>
        <form method="post" action="/settings/recurring" class="stack">
            <label>Template / テンプレート
                <select name="task_template_id" required>
                    {% for t in templates %}
                    <option value="{{ t.id }}">{{ t.title }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Frequency / 生成間隔
                <select name="frequency">
                    <option value="daily">{{ strings['settings.frequency.daily'] }}</option>
                    <option value="weekly" selected>{{ strings['settings.frequency.weekly'] }}</option>
                    <option value="monthly">{{ strings['settings.frequency.monthly'] }}</option>
                </select>
            </label>
            <label>{{ strings['settings.recurring.next'] }}<input type="date" name="next_run_date" value="{{ (today or '').isoformat() if today else '' }}"></label>
            <label>{{ strings['tasks.assignee'] }}
                <select name="assignee_user_id">
                    <option value="">-</option>
                    {% for member in assignees %}
                    <option value="{{ member.id }}">{{ member.display_name }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">{{ strings['settings.recurring.add'] }}</button>
        </form>
        <div class="rule-list">
            {% for r in recurring_rules %}
            <div class="rule">
                <div>
                    <strong>{{ strings['settings.frequency.' ~ r.frequency] }} • {{ r.next_run_date }}</strong>
                    <p class="muted">Template #{{ r.task_template_id }} → {% if r.assignee_user_id %}{{ assignee_map[r.assignee_user_id].display_name if assignee_map.get(r.assignee_user_id) else r.assignee_user_id }}{% else %}未アサイン{% endif %}</p>
                </div>
                <form method="post" action="/settings/recurring/{{ r.id }}/toggle">
                    <label class="switch">
                        <input type="checkbox" name="active" value="on" {% if r.active %}checked{% endif %} onchange="this.form.submit()">
                        <span>{{ strings['tasks.active'] }}</span>
                    </label>
                </form>
            </div>
            {% else %}
            <p class="muted">{{ strings['settings.recurring.none'] }}</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h3>食材単位の管理</h3>
        <form method="post" action="/settings/unit-options" class="inline-form">
            <label>単位
                <input name="name" placeholder="例: 個" required>
            </label>
            <button type="submit">追加</button>
        </form>
        <ul class="muted">
            {% for unit in unit_options %}
            <li>{{ unit.name }}</li>
            {% else %}
            <li>まだ単位がありません</li>
            {% endfor %}
        </ul>
    </div>
    <div class="card">
        <h3>料理タイプとセット</h3>
        <p class="muted">セットを選ぶと種別ごとのメニューを要求します。</p>
        <ul>
            {% for dt in dish_types %}
            <li>{{ dt.name }}</li>
            {% endfor %}
        </ul>
        <h4>セットテンプレート</h4>
        <ul>
            {% for s in meal_sets %}
            <li>{{ s.name }} — {{ s.description }}</li>
            {% else %}
            <li class="muted">セットが未登録です</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}
