# Household chore board MVP implementation

This ExecPlan is a living document. The sections `Progress`, `Surprises & Discoveries`, `Decision Log`, and `Outcomes & Retrospective` must be kept up to date as work proceeds. Maintain this document according to .agent/PLANS.md at all times.

## Purpose / Big Picture

Deliver a working household chore ordering web app that matches PROJECT_PLAN.md. Users in the same household can log in, register tasks, claim and work on them, and approve completion to earn points. They can also define task templates, register reward templates, request reward usage, and view balances and histories from a browser. The result should be runnable locally with a lightweight stack and provide HTML pages for core flows.

## Progress

- [x] (2025-01-15 00:00Z) Created ExecPlan skeleton and recorded goals.
- [x] Set up FastAPI project structure, dependencies, and database models for households, users, tasks, templates, rewards, and point transactions.
- [x] Implement authentication (register household/join existing, login/logout) with session cookies and password hashing.
- [x] Implement task flows: create tasks (with templates), claim, start, complete report, approve with point awarding, cancel; include statuses and numbers.
- [x] Implement task template CRUD with relative due date defaults.
- [x] Implement reward templates and reward usage requests with point deduction and optional approval.
- [x] Build HTML pages (dashboard, task list/detail/new, templates, reward pages, point history) with simple styling and navigation.
- [x] Add point balance views and history listings per user and household-wide.
- [x] (2025-01-15 01:30Z) Completed README/run instructions and automated tests for key flows; awaiting environment package installation to execute them locally.
- [ ] (2025-01-15 01:30Z) Validation pending: dependency installation still blocked by proxy; need to rerun pip install and pytest when connectivity available, then finalize retrospective.

## Surprises & Discoveries

- Observation: External package installation via pip failed because outbound traffic is blocked by a proxy (HTTP 403), so runtime verification could not proceed in this environment.
  Evidence: `pip install -r requirements.txt` returned ProxyError and reported no matching distributions.

## Decision Log

- Decision: Use FastAPI + SQLModel with SQLite for quick local persistence and simple session-based authentication via Starlette SessionMiddleware.
  Rationale: Meets browser-based MVP needs with minimal setup and built-in templating support while avoiding heavy front-end frameworks.
  Date/Author: 2025-01-15 / assistant

## Outcomes & Retrospective

Implemented FastAPI/SQLModel app covering authentication, task lifecycle with approvals and points, task/reward templates, reward use requests, balances, and HTML pages with navigation and styles. README and pytest suites are in place. Remaining gap: cannot verify runtime or install dependencies in this environment due to outbound proxy restrictions; next step is to install requirements (or vendor wheels) and rerun pytest plus manual browser flows.

## Context and Orientation

The repository currently contains only PROJECT_PLAN.md and empty execplans/. There is no application code. We will create an `app/` package for FastAPI code, SQLModel models, and Jinja2 templates, plus static assets and tests. SQLite will be stored in the project root as `order_system.db` for simplicity. Authentication will rely on household-scoped users stored in the database, with session cookies storing `user_id` and `household_id`.

## Plan of Work

1. Initialize Python project metadata and dependencies by adding `requirements.txt` (FastAPI, SQLModel, Uvicorn, Jinja2, passlib[bcrypt], python-multipart) and creating `app/__init__.py` for package recognition. Add a small `scripts` or commands section in README for installation and running the dev server.
2. Build database setup in `app/db.py` (engine, session generator, initialization helper) and define SQLModel models in `app/models.py` for Household, User, Task, TaskTemplate, RewardTemplate, RewardUse, and PointTransaction, including enums for statuses and priorities. Provide helper methods to compute task order numbers and point balances.
3. Implement authentication utilities in `app/auth.py` (password hashing, session management helpers, dependency to fetch current user and enforce login). Set up FastAPI application in `app/main.py`, attach SessionMiddleware with configurable secret, and include startup initialization to create tables.
4. Implement routes and handlers in `app/routes.py` (or inside main) for:
   - Auth: register (create or join household) and login/logout.
   - Dashboard: show current user info, balances, open/assigned tasks summary.
   - Tasks: list/filter, create new (with optional template selection), detail view, transitions (claim, start, complete report, approve, cancel). Ensure approval creates a PointTransaction once per task and supports recording actual points.
   - Task templates: list, create, edit, delete; applying template pre-fills new task form with title/category/points and relative due date.
   - Rewards: reward templates CRUD; reward usage request/approval; deduct points on approval and store transactions.
   - Point history: per-user and household transaction listings with running balances.
5. Create Jinja2 templates under `app/templates/` with a base layout, navbar, flash message area, and pages for login/register, dashboard, task list/detail/form, template lists, reward pages, and history. Add minimal CSS under `app/static/style.css` for readability and responsive layout.
6. Add utilities to calculate balances (sum of PointTransaction amounts) and format dates. Include validation for due dates and ensure only one reward approval reduces points once. Prevent duplicate point awards for tasks by checking for existing transaction tied to the task.
7. Write tests under `tests/` using `pytest` to cover authentication hashing utilities, task approval awarding points, and reward approval deducting points. Include a simple test client using FastAPI TestClient with in-memory SQLite.
8. Document usage in `README.md`: dependency installation, running the server, default environment variables, and basic workflow demonstration steps.
9. Run formatting (if applicable), tests, and manual sanity check by starting server and loading key pages if feasible. Update `Progress`, `Surprises`, `Decision Log`, and `Outcomes` accordingly.

## Concrete Steps

- From repo root, install dependencies via `pip install -r requirements.txt` (after adding file). Use `uvicorn app.main:app --reload` to run the dev server. Commands and expected outputs will be updated as they are verified.
- Use FastAPI TestClient in tests with an in-memory SQLite URL `sqlite://` to ensure tables create per test.
- Manual validation: start server, create household/user via /register, log in, create a task, claim/start/complete/approve to see point balance increase, create reward template and request + approve usage to see balance decrease.

## Validation and Acceptance

Acceptance requires:
- Users can register or join a household, log in, and stay authenticated via session cookies. Unauthorized access redirects to login.
- Task creation captures required fields (title, category, due date, proposed points, priority, notes) and assigns an order number. Templates can prefill values. Task flows allow claim → in progress → completion report → approval awarding points, and points appear in history and dashboard balances. Cancellation is available.
- Task templates CRUD works and relative due days apply when creating a task from a template.
- Reward templates CRUD works; reward usage requests record a pending item, and approval deducts points and records history; rejection leaves balance unchanged.
- Dashboard displays balances and task summaries; history pages list point transactions with types and links to related task/reward where relevant.
- README documents setup and run instructions; automated tests pass.

## Idempotence and Recovery

Database initialization is idempotent and handled on startup; rerunning the app recreates tables if missing. Actions are guarded to prevent duplicate point awards by checking for existing PointTransaction for a task or reward approval. If a transaction fails mid-request, the FastAPI dependency-scoped session rollback will avoid partial writes. In case of corrupted DB, deleting `order_system.db` will reset the state; instructions will note this. Session logout clears cookies.

## Artifacts and Notes

During implementation, include concise excerpts of responses or test outputs here once available to illustrate successful validation steps.

## Interfaces and Dependencies

Primary external libraries: FastAPI (web framework), SQLModel (ORM on SQLAlchemy), passlib[bcrypt] for password hashing, python-multipart for form uploads, Jinja2 for templating, and Uvicorn for dev server. Models reside in `app/models.py` using SQLModel classes. Authentication helpers live in `app/auth.py`. Route handlers live in `app/main.py` (and optionally helpers in `app/routes.py` if split). Templates under `app/templates/` and static assets under `app/static/`. Tests under `tests/` use `fastapi.testclient.TestClient`.

Updates: None yet beyond initial creation.
