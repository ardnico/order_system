# PROJECT_PLAN: 家事ポイント受発注 Web アプリ  
## ＋ 献立・買い物支援拡張

---

## 1. 概要

### 1.1 プロジェクト名（仮）

- 家事受発注ポイントボード（仮）
- 拡張モジュール名（仮）：献立＆買い物プランナー

### 1.2 コンセプト

- 既存機能：
  - 家の中の「家事」をタスクとして **発注／受注** できる Web アプリ
  - タスク完了に応じて **ポイントを付与・蓄積** し、
    ポイントを使って「ご褒美／特典」を **申請・消費** できる
  - 「発注書」に近い形で、内容・期日・条件を明示し、家事分担を見える化

- 拡張機能（今回追加）：
  - 「期間指定の献立（昼・夜）」を決めると、必要な材料を **自動集計** してくれる献立・買い物支援機能
  - 週単位などで献立を決め、材料リストを元に買い物できるワークフローを Web から提供
  - 将来的に「料理担当の家事ポイント」とも連動できる拡張性を持つ

### 1.3 想定利用者

- 同居している家族（夫婦・カップル・親子など）
- 家事分担をポイントで見える化したい人
- 週単位で献立をまとめて決めたい家庭の料理担当者
- スマホ / タブレット / PC のブラウザからアクセスするユーザ

---

## 2. ゴール / アンチゴール

### 2.1 ゴール（既存＋拡張の全体）

- G1: 家事タスクの発注〜受注〜完了承認〜ポイント付与が Web 上で完結している
- G2: ポイント残高と履歴がユーザ単位で参照でき、ご褒美用途として消費可能
- G3: 期間（例：1週間）の昼・夜献立を、紙と電卓より **体感 50%以上** 楽・高速に作成できる
- G4: 指定期間に必要な材料を、材料名＋単位ごとに **合算して一覧表示** できる
- G5: メニューを「種類」や「種類セット」で絞り込んで選び、献立のバランスを取りやすい
- G6: ログイン後 5 分以内に「1〜2日分の献立を作り、材料一覧を見る」まで到達できる UX
- G7: （拡張案）献立から「料理タスク」を自動 or 半自動で家事タスクとして登録し、ポイント付与と連動できる設計にしておく（Phase2 以降）

### 2.2 アンチゴール（やらないこと）

- 写真付きレシピサイト並みの詳細レシピコンテンツ提供
- 栄養計算（カロリー・PFC バランスなど）の自動計算
- EC サイトへの自動発注やスーパーの在庫・価格情報との連携
- スマホネイティブアプリ（iOS / Android）の実装
- 公開 SaaS としてのユーザ課金・マルチテナント
- 全レシピ検索エンジンのような巨大なレシピ探索機能
- リアルタイム多端末同期（v1 時点）

---

## 3. 制約 / 前提

### 3.1 技術スタック

- **前提**：既存の FastAPI + SQLModel ベースの家事ポイント Web アプリと同一スタックを利用する
  - Backend：Python 3.11 / FastAPI / SQLModel / Starlette セッション
  - Frontend：FastAPI のテンプレート（Jinja2）＋既存の静的アセット
  - DB：SQLModel 経由の RDB。デフォルトはリポジトリ直下の SQLite（`order_system.db`）、`DATABASE_URL` で PostgreSQL などに差し替え可。

※ 既存アプリと同一の依存関係・フォルダ構成を踏襲し、拡張モジュールとして追加する。

### 3.2 対応環境

- Web ブラウザ（PC / タブレット / スマホ）
- ローカルネットワーク or 自宅サーバでの運用を想定（インターネット公開は任意）

### 3.3 データ保存 / オフライン性

- すべてサーバ側の DB に永続化
- ブラウザ側は基本オンライン前提だが、LAN 内完結でネット不要
- 「完全オフライン（PWA＋ローカル DB）」までは scope 外（将来検討）

---

## 4. 全体アーキテクチャ

### 4.1 レイヤ構成

- プレゼンテーション層（UI）
  - 家事ポイント画面群（既存）
  - 献立・買い物拡張画面群（今回追加）
- アプリケーション層
  - 家事タスク用サービス / Store
  - ポイント・ご褒美用サービス
  - 献立・材料集計用サービス / Store
- ドメイン層
  - 家事ドメイン：Task / TaskTemplate / PointTransaction / Reward* …
  - 献立ドメイン：MealPlan / MealPlanDay / Menu / MenuType / MenuTypeSet / Ingredient …
  - 共通：User / Household
- インフラ層
  - 現行の Repository 実装 + 献立系 Repository を追加

### 4.2 モジュール境界

- 家事モジュール：タスク・ポイント・ご褒美
- 献立モジュール：献立、メニュー、材料集計
- 連携部分：
  - 献立から「○日の夕食調理」などの Task を自動生成するフック（Phase2 以降）

---

## 5. 機能要件

### 5.1 既存機能（要約）

- Household / User 管理、ログイン
- 家事タスク発注（発注書イメージ）
  - タイトル、詳細、カテゴリ、期日、ポイント（見積）、優先度、発注者、受注者 など
- タスクのステータス遷移：発注中 → 受注済み → 作業中 → 完了報告 → 完了承認
- 完了承認時のポイント自動付与
- ユーザごとのポイント残高・履歴表示
- ご褒美用途（Reward）の登録とポイント消費
- タスクテンプレート管理

※ ここはすでに実装済み前提。詳細は既存ドキュメント参照。

---

### 5.2 拡張機能：献立・買い物支援モジュール

#### 5.2.1 期間設定機能

- 機能：
  - 開始日・終了日を指定し、その期間の日付リストを生成（例：7日間）
  - 期間内各日について「昼」「夜」のスロットを用意
- 挙動：
  - 期間変更時：
    - 新しい範囲外になった日付の献立は削除（ユーザの意図確認ダイアログは Phase2 検討）
    - 新しい範囲内の日付の PlanDay を再構成

#### 5.2.2 日別・昼夜献立編集

- 各日付の「昼」「夜」にメニューを 1 件ずつ割り当て
- 操作：
  - メニュー選択モーダルから選択
  - 既存の選択メニューの変更
  - メニューのクリア（未設定に戻す）
- 表示：
  - 日付ごとに「昼：メニュー名」「夜：メニュー名」を表示
  - メニュー未設定時は placeholder（例：「未設定」）

#### 5.2.3 メニュー一覧 + 種類 / 種類セット

- メニュー（Menu）には以下の属性を持たせる：
  - name（メニュー名）
  - type（MenuType: 和食 / 洋食 / 中華 / 麺類 / 丼物 / 時短 …）
  - tags / flags（任意：時短・ヘルシーなど）
  - ingredients（紐づく材料リスト）
- メニュー選択モーダル：
  - 種類（type）でフィルタ
  - 種類セット（MenuTypeSet）でフィルタ
    - 例：和食中心セット、時短セット、ヘルシーセット
  - フリーテキスト検索（name 部分一致）

- 種類セット：
  - v1 ではサーバ側に固定定義（DB or 設定ファイル）
  - ユーザ編集は Phase2 以降の候補

#### 5.2.4 材料集計（買い物リスト生成）

- 対象：
  - 指定期間内に含まれるすべてのメニュー（昼・夜）
- ロジック：
  - 各メニューが持つ Ingredient（材料）リストを集約
  - 「材料名 + 単位」でグルーピングし、数量を合計
    - 例：玉ねぎ / 個 → 合計 5 個
    - 単位が違うもの（個 と g）は別グループとして扱う（v1 の割り切り）
- 出力：
  - 材料一覧画面
    - 材料名
    - 合計数量
    - 単位
  - オプション：
    - チェックボックスで「買った」マーク（ブラウザ側 state だけでも良い）

#### 5.2.5 献立一覧画面

- 指定期間全体の「日付 × 昼夜 × メニュー名」を一覧表示
- 機能：
  - 簡易カレンダー表示（テーブル形式でもよい）
  - 各セルをクリックで詳細・編集画面へ遷移
  - 種類ごとの色分け（和食=青系、洋食=赤系…などは UI の話）

#### 5.2.6 メニュー管理

- 最低限：
  - メニュー一覧表示
  - 新規メニュー追加
    - 名前
    - 種類（MenuType）
    - 材料リスト（Ingredient name / quantity / unit）
  - 編集（名称・種類・材料の修正）
- 削除：
  - v1 では「使用中メニューの削除」をどう扱うか要検討（オープン事項へ）
- 初期データ：
  - 家庭でよく使う 20〜30 メニューを初期投入
  - サーバの seed データとして持つ

#### 5.2.7 家事ポイントとの連携（Phase2 以降）

- 方針：
  - 初期実装では「機能的には独立」でもよい
  - 将来的に以下のような連携を想定：

1. 献立から家事タスク生成
   - 例：「2025-12-10 の夕食調理」という Task を自動発注
   - Task に紐づく情報：
     - 期日：同日 or 調理開始時間
     - タイトル：「夕食調理（メニュー：○○＋△△）」
     - ポイント：メニュー数などから自動算出 or テンプレートから設定

2. ポイント履歴から献立の実行状況を把握
   - 実際に料理されたかどうかを Task 完了承認で判定

※ 実装タイミング・仕様詳細は「オープンな検討事項」に回す。

---

## 6. ドメインモデル（概略）

### 6.1 既存エンティティ（再掲）

- `User`
- `Household`
- `Task`
- `TaskTemplate`
- `PointTransaction`
- `RewardTemplate`
- `RewardUse`

### 6.2 追加エンティティ（献立系）

- `MealPlan`
  - id
  - household_id
  - name（任意、例：今週の献立）
  - start_date
  - end_date
  - created_by
  - created_at
  - updated_at

- `MealPlanDay`
  - id
  - meal_plan_id
  - date
  - lunch_menu_id (nullable)
  - dinner_menu_id (nullable)
  - note (nullable)

- `Menu`
  - id
  - household_id（共有 or 個別）
  - name
  - type_id（MenuType）
  - description (nullable)
  - is_active
  - created_at
  - updated_at

- `MenuType`
  - id
  - name（和食 / 洋食 / 中華 / 時短 / 丼物 …）
  - description (nullable)

- `MenuTypeSet`
  - id
  - name（和食中心 / 時短 / ヘルシー etc.）
  - description
  - included_type_ids（MenuType のリスト）

- `Ingredient`
  - id
  - name（玉ねぎ、豚こま肉、牛乳 etc.）
  - default_unit（個 / g / ml / 本 …）
  - note (nullable)

- `MenuIngredient`（Menu と Ingredient の中間）
  - id
  - menu_id
  - ingredient_id
  - quantity (numeric)
  - unit（上書き用、null なら Ingredient.default_unit）

※ 材料集計は `MealPlanDay` → `Menu` → `MenuIngredient` → `Ingredient` のチェーンで計算。

---

## 7. 画面構成（追加分）

1. **献立ダッシュボード**
   - 対象期間の MealPlan 一覧
   - 「新規献立を作成」ボタン

2. **献立編集画面**
   - 期間（start/end）の設定
   - 日付 × 昼夜 × メニュー名のテーブル
   - セルクリックでメニュー選択モーダル表示

3. **メニュー選択モーダル**
   - メニュー一覧（スクロール）
   - 種類（MenuType）フィルタ
   - 種類セット（MenuTypeSet）フィルタ
   - 検索ボックス

4. **材料集計画面**
   - 指定 MealPlan の材料一覧
   - 材料名 / 合計数量 / 単位
   - 「チェック済み」トグル（買い物メモ用途）

5. **メニュー管理画面**
   - メニュー一覧
   - 新規追加 / 編集 / （削除の扱いは要検討）
   - 材料リスト編集 UI

※ 既存の家事タスク画面はそのまま、ナビゲーションから献立モジュールへ遷移できる構成を想定。

---

## 8. 非機能要件（追加観点）

- パフォーマンス
  - 1 週間分（14 メニュー）＋メニュー数 100 件程度で、材料集計は体感 0.5 秒未満
- ユーザビリティ
  - 初回利用時でも、チュートリアル無しで
    「期間設定 → 献立入力 → 材料一覧」まで操作できる
- 信頼性
  - ブラウザリロードやサーバ再起動でも献立データが失われない（DB 永続化）
- メンテナンス性
  - 献立ドメインのロジック（材料集計・期間変更）はサービス層 or ドメイン層に閉じる
  - 既存家事ドメインとの依存関係は最小限（連携部分は明示）

---

## 9. 開発フェーズ

### Phase 1：献立モジュール単体 MVP

- MealPlan / MealPlanDay / Menu / Ingredient / MenuIngredient の実装
- 期間設定＋日別昼夜献立編集 UI
- 材料集計ロジックと材料一覧画面
- メニューの簡易管理（追加・編集）

**完了条件：**
- ブラウザから 1 週間分の献立を作成
- 材料一覧を表示して買い物リストとして使える状態

### Phase 2：UX 強化・メニューセット

- MenuType / MenuTypeSet 導入
- メニュー選択モーダルにフィルタを実装
- 献立一覧画面の見やすさ改善（色分け・テーブルレイアウト）

### Phase 3：家事ポイントとの連携

- MealPlanDay から Task 自動生成フロー
  - タスクテンプレート or 設定で生成ルールを定義
- 料理タスク完了承認 → 献立の「実行済フラグ」更新（任意）
- 家事ポイント画面からも「今週の料理タスク」一覧が見えるようにする

---

## 10. リスク / 前提条件

### 10.1 主なリスク

- R1: 材料単位のバラつき
  - 「個」と「g」などが混ざると集計できない
  - → v1 は「材料名＋単位」で別物扱いに割り切り、単位選択を UI で制限

- R2: メニュー・種類・種類セットが増えすぎて UI が複雑化
  - → MVP 段階ではメニュー種類 5〜7 種、種類セット 3〜5 個に制限

- R3: 既存家事機能との連携が複雑になりすぎる
  - → Phase3 まで献立モジュールは「ほぼ独立」運用とし、
    連携は Task 自動生成のみに絞る

- R4: 既存コードベースとの整合性
  - → 現行スタックと同じ設計原則（フォルダ構成・テスト戦略など）を踏襲し、
    既存プロジェクトに自然に組み込む

### 10.2 前提条件

- 利用者は 1〜4 人家族を想定
- Household 単位で献立を共有する前提
- 開発者自身がヘビーユーザとして使いながら改善する

---

## 11. オープンな検討事項（迷いどころの整理）

- Q1: 献立と家事タスクの連携粒度
  - 1 日の料理を 1 タスクにするか、メニューごとにタスクを分けるか
  - 料理タスクのポイントをどう計算するか（固定 / メニュー数による係数 etc.）

- Q2: メニュー削除の扱い
  - すでに MealPlan に使われているメニューを削除可能にするか
  - 論理削除（is_active）だけにするか

- Q3: 初期メニュー数
  - 20 件程度にするか、使いやすさのため 50 件程度まで増やすか
  - データ入力コストとのバランス

- Q4: 端末ターゲットと UI 最適化
  - タブレット（iPad 等）の利用をどこまで意識するか
  - PC 向けとスマホ向けでレイアウトをどこまで分けるか

- Q5: 将来のオフライン対応
  - PWA＋ローカルキャッシュまで踏み込むか
  - 「LAN 内サーバ＋ブラウザのみ」で割り切るか

---

## 12. 今回拡張の「ボトルネック」と着手順

- 現時点のボトルネック：
  - 「献立決め〜買い物リスト作成」が家事ポイントシステムと切り離されており、  
    毎回人力でやる必要があること

- それを壊すための着手順：
  1. **Phase1** で献立モジュール単体を完成させ、  
     「期間指定 → 献立入力 → 材料一覧」が通る状態を作る
  2. **Phase2** でメニュー種類・種類セット・UI を整えて、  
     実用レベルで「選びやすい」状態にする
  3. **Phase3** で家事タスク連携を入れ、  
     「献立＝料理タスクの計画表」としてポイント設計とつなぐ

これで、「家事ポイント」と「献立・買い物」が同じ Web アプリ上で一貫したワークフローになる。
